parameters:
- name: environment  # defaults for any parameters that aren't specified
  default: ''
- name: appservice
  default: ''

stages:
  - stage: DeployStage${{parameters.environment}}
    displayName: ' Deployed to ${{parameters.environment}}'
    jobs:
      - deployment: ${{parameters.environment }}
        displayName: ${{parameters.environment }} 'deployment'
        environment: ${{parameters.environment }}
        strategy:
          runOnce:
            deploy:
              steps:
                - task: Bash@3
                  inputs:
                    targetType: 'inline'
                    script: |
                      # Write your commands here
                      env="$(./1.sh env $(Build.SourceBranchName))"
                      echo "##vso[task.setvariable variable=env]$env"       
      
                - task: Bash@3
                  inputs:
                    targetType: 'inline'
                    script: |
                      # Write your commands here
                      appservice="$(./1.sh appservice $(Build.SourceBranchName))"
                      echo "##vso[task.setvariable variable=appservice]$appservice"
      
                - task: DownloadPipelineArtifact@2
                  inputs:
                    buildType: 'current'
                    artifactName: 'drop'
                    targetPath: '$(Pipeline.Workspace)/drop'
            
                - powershell: |
                    Compress-Archive -Path "$(Pipeline.Workspace)/drop/*" -DestinationPath "$(Pipeline.Workspace)/drop.zip" -Force

                - task: AzureRmWebAppDeployment@4
                  inputs:
                    ConnectionType: 'AzureRM'
                    azureSubscription: 'DevopsLearnAppService'
                    appType: 'webApp'
                    WebAppName: ${{parameters.appservice }}
                    packageForLinux: '$(Pipeline.Workspace)/**/*.zip'