stages:
  - stage: ChooseEnvStage
    displayName: 'Choose environment'
    jobs:
      - job: ChooseEnvJob
        steps:
        - task: Bash@3
          inputs:
            targetType: 'inline'
            name: envscript
            script: |
              # Write your commands here
              env="$(./1.sh env $(Build.SourceBranchName))"
              echo "##vso[task.setvariable variable=env;isOutput=true]$env"       
        
        - task: Bash@3
          inputs:
            targetType: 'inline'
            name: appservicescript
            script: |
             # Write your commands here
             appservice="$(./1.sh appservice $(Build.SourceBranchName))"
             echo "##vso[task.setvariable variable=appservice;isOutput=true]$appservice"

  - stage: DeployStage
    displayName: "Deployed to App service"
    dependsOn: ChooseEnvStage
    jobs:
      - deployment: $[ stageDependencies.{ChooseEnvStage}.{ChooseEnvJob}.outputs['{envscript}.{env}'] 
        displayName: $[ stageDependencies.{ChooseEnvStage}.{ChooseEnvJob}.outputs['{envscript}.{env}'] 
        environment: $[ stageDependencies.{ChooseEnvStage}.{ChooseEnvJob}.outputs['{envscript}.{env}'] 
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadPipelineArtifact@2
                  inputs:
                    buildType: 'current'
                    artifactName: 'drop'
                    targetPath: '$(Pipeline.Workspace)/drop'
            
                - powershell: |
                    Compress-Archive -Path "$(Pipeline.Workspace)/drop/*" -DestinationPath "$(Pipeline.Workspace)/drop.zip" -Force

                - task: AzureRmWebAppDeployment@4
                  inputs:
                    ConnectionType: 'AzureRM'
                    azureSubscription: 'DevopsLearnAppService'
                    appType: 'webApp'
                    WebAppName: $[stageDependencies.ChooseEnvStage.ChooseEnvJob.outputs['appservice']]
                    packageForLinux: '$(Pipeline.Workspace)/**/*.zip'